# Step 1: Use official Node.js image for building the backend
FROM node:18 AS builder

# Set the working directory to /app
WORKDIR /app

# Define build arguments for all environment variables
ARG PORT=5004
ARG NODE_ENV=production
ARG EMAIL_USER
ARG EMAIL_PASSWORD
ARG OPENAI_API_KEY
ARG MONGODB_URI
ARG Net_Secret
ARG HEDERA_ACCOUNT_ID
ARG HEDERA_PRIVATE_KEY
ARG HEDERA_PUBLIC_KEY
ARG HEDERA_NETWORK=testnet
ARG LINKEDIN_CLIENT_ID
ARG LINKEDIN_CLIENT_SECRET
ARG LINKEDIN_REDIRECT_URI
ARG TOGETHER_API_KEY

# Set environment variables from build arguments
ENV PORT=$PORT
ENV NODE_ENV=$NODE_ENV
ENV EMAIL_USER=$EMAIL_USER
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV MONGODB_URI=$MONGODB_URI
ENV Net_Secret=$Net_Secret
ENV HEDERA_ACCOUNT_ID=$HEDERA_ACCOUNT_ID
ENV HEDERA_PRIVATE_KEY=$HEDERA_PRIVATE_KEY
ENV HEDERA_PUBLIC_KEY=$HEDERA_PUBLIC_KEY
ENV HEDERA_NETWORK=$HEDERA_NETWORK
ENV LINKEDIN_CLIENT_ID=$LINKEDIN_CLIENT_ID
ENV LINKEDIN_CLIENT_SECRET=$LINKEDIN_CLIENT_SECRET
ENV LINKEDIN_REDIRECT_URI=$LINKEDIN_REDIRECT_URI
ENV TOGETHER_API_KEY=$TOGETHER_API_KEY

# Copy package.json and package-lock.json into the container
COPY package.json  ./

# Install dependencies
RUN npm install

RUN npm install google-auth-library

# Copy the rest of the backend code (excluding .env file)
COPY . .

# Step 2: Run the app in a production environment
FROM node:18-slim

# Set the working directory to /app
WORKDIR /app

# Define runtime arguments
ARG PORT=5004
ARG NODE_ENV=production
ARG EMAIL_USER
ARG EMAIL_PASSWORD
ARG OPENAI_API_KEY
ARG MONGODB_URI
ARG Net_Secret
ARG HEDERA_ACCOUNT_ID
ARG HEDERA_PRIVATE_KEY
ARG HEDERA_PUBLIC_KEY
ARG HEDERA_NETWORK=testnet
ARG LINKEDIN_CLIENT_ID
ARG LINKEDIN_CLIENT_SECRET
ARG LINKEDIN_REDIRECT_URI
ARG TOGETHER_API_KEY

# Set runtime environment variables
ENV PORT=$PORT
ENV NODE_ENV=$NODE_ENV
ENV EMAIL_USER=$EMAIL_USER
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV MONGODB_URI=$MONGODB_URI
ENV Net_Secret=$Net_Secret
ENV HEDERA_ACCOUNT_ID=$HEDERA_ACCOUNT_ID
ENV HEDERA_PRIVATE_KEY=$HEDERA_PRIVATE_KEY
ENV HEDERA_PUBLIC_KEY=$HEDERA_PUBLIC_KEY
ENV HEDERA_NETWORK=$HEDERA_NETWORK
ENV LINKEDIN_CLIENT_ID=$LINKEDIN_CLIENT_ID
ENV LINKEDIN_CLIENT_SECRET=$LINKEDIN_CLIENT_SECRET
ENV LINKEDIN_REDIRECT_URI=$LINKEDIN_REDIRECT_URI
ENV TOGETHER_API_KEY=$TOGETHER_API_KEY

# Copy the installed dependencies and source code from the builder stage
COPY --from=builder /app ./

# Install only production dependencies (for smaller image size)
RUN npm install --production

# Expose the port your Express app will run on
EXPOSE $PORT

# Run the app in production mode
CMD ["npm", "start"]
